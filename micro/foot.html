/* virtual machine: command opcodes constants */

const NOP = 0x00;
const BYE = 0xFF;

/* hex dump: JS have no printf %.4X */

function Xn(N,padding) {
	var hex = N.toString(0x10).toUpperCase()
	while (hex.length < padding ) hex = '0'+hex; 
	return hex;
}
function XXXX(N) { return Xn(N,4); }
function   XX(N) { return Xn(N,2); }

/* debug */

var log = { addr:'', op:'', cmd:'', params:'' };

function _log() {
	console.log( "\n"+XXXX(log.addr)+":\t"+XX(log.op)+"\t"+log.cmd+"\t"+log.params );
}

/* virtual machine: bytecode interpreter */

function _NOP() { log.cmd='nop'; }

var bye = false;	// stop flag
function _BYE() { log.cmd='bye'; bye=true; }

/* virtual machine: bytecode interpreter */

function VM() {
	while (!bye) {
		log.addr = Ip; var op = M[Ip++]; log.op = op;
		switch (op) {
			case NOP: _NOP(); break;
			case BYE: _BYE(); break;
			default: throw new Error('bad command '+XXXX(Ip-1)+":"+XX(op));
		}
		_log();
	}
}

window.onload = function() { VM(); }

</script>
